<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RocksDB Doxygen: fuzz 디렉토리 참조</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RocksDB Doxygen
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 다음에 의해 생성됨 :  Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','검색',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_b05962af846a36bbc52d05dfc046b2b4.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">로딩중...</div>
<div class="SRStatus" id="Searching">검색중...</div>
<div class="SRStatus" id="NoMatches">일치하는것 없음</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">fuzz 디렉토리 참조</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
fuzz에 대한 디렉토리 의존성 그래프:</div>
<div class="dyncontent">
<div class="center"><img src="dir_b05962af846a36bbc52d05dfc046b2b4_dep.png" border="0" usemap="#adir__b05962af846a36bbc52d05dfc046b2b4__dep" alt="fuzz"/></div>
<map name="adir__b05962af846a36bbc52d05dfc046b2b4__dep" id="adir__b05962af846a36bbc52d05dfc046b2b4__dep">
<area shape="rect" href="dir_b05962af846a36bbc52d05dfc046b2b4.html" title="fuzz" alt="" coords="51,5,99,33"/>
<area shape="rect" href="dir_7cea70ad8000b4ba25606f1df9c7574a.html" title="table" alt="" coords="5,81,60,109"/>
<area shape="poly" href="dir_000030_000064.html" alt="" coords="70,35,50,69,45,66,65,32"/>
<area shape="rect" href="dir_000030_000064.html" title="2" alt="" coords="53,61,61,78"/>
<area shape="rect" href="dir_d44c64559bbebec7f509842c48db8b23.html" title="include" alt="" coords="84,81,152,109"/>
<area shape="poly" href="dir_000030_000035.html" alt="" coords="85,32,105,66,100,69,80,35"/>
<area shape="rect" href="dir_000030_000035.html" title="5" alt="" coords="104,52,112,69"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
파일들</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="d2/daf/db__fuzzer_8cc_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="d2/daf/db__fuzzer_8cc.html">db_fuzzer.cc</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="d2/dc6/db__map__fuzzer_8cc_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="d2/dc6/db__map__fuzzer_8cc.html">db_map_fuzzer.cc</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="db/d21/sst__file__writer__fuzzer_8cc_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="db/d21/sst__file__writer__fuzzer_8cc.html">sst_file_writer_fuzzer.cc</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="d8/d3c/util_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="d8/d3c/util_8h.html">util.h</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">상세한 설명</h2>
<h1><a class="anchor" id="autotoc_md42"></a>
Overview</h1>
<p>This directory contains <a href="https://en.wikipedia.org/wiki/Fuzzing">fuzz tests</a> for RocksDB. RocksDB testing infrastructure currently includes unit tests and <a href="https://github.com/facebook/rocksdb/wiki/Stress-test">stress tests</a>, we hope fuzz testing can catch more bugs.</p>
<h1><a class="anchor" id="autotoc_md43"></a>
Prerequisite</h1>
<p>We use <a href="http://llvm.org/docs/LibFuzzer.html">LLVM libFuzzer</a> as the fuzzying engine, so make sure you have <a href="https://clang.llvm.org/get_started.html">clang</a> as your compiler.</p>
<p>Some tests rely on <a href="https://github.com/google/fuzzing/blob/master/docs/structure-aware-fuzzing.md">structure aware fuzzing</a>. We use <a href="https://developers.google.com/protocol-buffers">protobuf</a> to define structured input to the fuzzer, and use <a href="https://github.com/google/libprotobuf-mutator">libprotobuf-mutator</a> as the custom libFuzzer mutator. So make sure you have protobuf and libprotobuf-mutator installed, and make sure <code>pkg-config</code> can find them. On some systems, there are both protobuf2 and protobuf3 in the package management system, make sure protobuf3 is installed.</p>
<p>If you do not want to install protobuf library yourself, you can rely on libprotobuf-mutator to download protobuf for you. For details about installation, please refer to <a href="https://github.com/google/libprotobuf-mutator#readme">libprotobuf-mutator README</a></p>
<h1><a class="anchor" id="autotoc_md44"></a>
Example</h1>
<p>This example shows you how to do structure aware fuzzing to <code>rocksdb::SstFileWriter</code>.</p>
<p>After walking through the steps to create the fuzzer, we'll introduce a bug into <code>rocksdb::SstFileWriter::Put</code>, then show that the fuzzer can catch the bug.</p>
<h2><a class="anchor" id="autotoc_md45"></a>
Design the test</h2>
<p>We want the fuzzing engine to automatically generate a list of database operations, then we apply these operations to <code>SstFileWriter</code> in sequence, finally, after the SST file is generated, we use <code>SstFileReader</code> to check the file's checksum.</p>
<h2><a class="anchor" id="autotoc_md46"></a>
Define input</h2>
<p>We define the database operations in protobuf, each operation has a type of operation and a key value pair, see <a href="proto/db_operation.proto">proto/db_operation.proto</a> for details.</p>
<h2><a class="anchor" id="autotoc_md47"></a>
Define tests with the input</h2>
<p>In <a href="sst_file_writer_fuzzer.cc">sst_file_writer_fuzzer.cc</a>, we define the tests to be run on the generated input:</p>
<div class="fragment"><div class="line">DEFINE_PROTO_FUZZER(DBOperations&amp; input) {</div>
<div class="line">  // apply the operations to SstFileWriter and use SstFileReader to verify checksum.</div>
<div class="line">  // ...</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>SstFileWriter</code> requires the keys of the operations to be unique and be in ascending order, but the fuzzing engine generates the input randomly, so we need to process the generated input before passing it to <code>DEFINE_PROTO_FUZZER</code>, this is accomplished by registering a post processor:</p>
<div class="fragment"><div class="line">protobuf_mutator::libfuzzer::PostProcessorRegistration&lt;DBOperations&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md48"></a>
Compile and link the fuzzer</h2>
<p>In the rocksdb root directory, compile rocksdb library by <code>make static_lib</code>.</p>
<p>Go to the <code>fuzz</code> directory, run <code>make sst_file_writer_fuzzer</code> to generate the fuzzer, it will compile rocksdb static library, generate protobuf, then compile and link <code>sst_file_writer_fuzzer</code>.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
Introduce a bug</h2>
<p>Manually introduce a bug to <code>SstFileWriter::Put</code>:</p>
<div class="fragment"><div class="line">diff --git a/table/sst_file_writer.cc b/table/sst_file_writer.cc</div>
<div class="line">index ab1ee7c4e..c7da9ffa0 100644</div>
<div class="line">--- a/table/sst_file_writer.cc</div>
<div class="line">+++ b/table/sst_file_writer.cc</div>
<div class="line">@@ -277,6 +277,11 @@ Status SstFileWriter::Add(const Slice&amp; user_key, const Slice&amp; value) {</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> Status SstFileWriter::Put(const Slice&amp; user_key, const Slice&amp; value) {</div>
<div class="line">+  if (user_key.starts_with(&quot;!&quot;)) {</div>
<div class="line">+    if (value.ends_with(&quot;!&quot;)) {</div>
<div class="line">+      return Status::Corruption(&quot;bomb&quot;);</div>
<div class="line">+    }</div>
<div class="line">+  }</div>
<div class="line">   return rep_-&gt;Add(user_key, value, ValueType::kTypeValue);</div>
<div class="line"> }</div>
</div><!-- fragment --><p>The bug is that for <code>Put</code>, if <code>user_key</code> starts with <code>!</code> and <code>value</code> ends with <code>!</code>, then corrupt.</p>
<h2><a class="anchor" id="autotoc_md50"></a>
Run fuzz testing to catch the bug</h2>
<p>Run the fuzzer by <code>time ./sst_file_writer_fuzzer</code>.</p>
<p>Here is the output on my machine:</p>
<div class="fragment"><div class="line">Corruption: bomb</div>
<div class="line">==59680== ERROR: libFuzzer: deadly signal</div>
<div class="line">    #0 0x109487315 in __sanitizer_print_stack_trace+0x35 (libclang_rt.asan_osx_dynamic.dylib:x86_64+0x4d315)</div>
<div class="line">    #1 0x108d63f18 in fuzzer::PrintStackTrace() FuzzerUtil.cpp:205</div>
<div class="line">    #2 0x108d47613 in fuzzer::Fuzzer::CrashCallback() FuzzerLoop.cpp:232</div>
<div class="line">    #3 0x7fff6af535fc in _sigtramp+0x1c (libsystem_platform.dylib:x86_64+0x35fc)</div>
<div class="line">    #4 0x7ffee720f3ef  (&lt;unknown module&gt;)</div>
<div class="line">    #5 0x7fff6ae29807 in abort+0x77 (libsystem_c.dylib:x86_64+0x7f807)</div>
<div class="line">    #6 0x108cf1c4c in TestOneProtoInput(DBOperations&amp;)+0x113c (sst_file_writer_fuzzer:x86_64+0x100302c4c)</div>
<div class="line">    #7 0x108cf09be in LLVMFuzzerTestOneInput+0x16e (sst_file_writer_fuzzer:x86_64+0x1003019be)</div>
<div class="line">    #8 0x108d48ce0 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) FuzzerLoop.cpp:556</div>
<div class="line">    #9 0x108d48425 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) FuzzerLoop.cpp:470</div>
<div class="line">    #10 0x108d4a626 in fuzzer::Fuzzer::MutateAndTestOne() FuzzerLoop.cpp:698</div>
<div class="line">    #11 0x108d4b325 in fuzzer::Fuzzer::Loop(std::__1::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) FuzzerLoop.cpp:830</div>
<div class="line">    #12 0x108d37fcd in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) FuzzerDriver.cpp:829</div>
<div class="line">    #13 0x108d652b2 in main FuzzerMain.cpp:19</div>
<div class="line">    #14 0x7fff6ad5acc8 in start+0x0 (libdyld.dylib:x86_64+0x1acc8)</div>
<div class="line"> </div>
<div class="line">NOTE: libFuzzer has rudimentary signal handlers.</div>
<div class="line">      Combine libFuzzer with AddressSanitizer or similar for better crash reports.</div>
<div class="line">SUMMARY: libFuzzer: deadly signal</div>
<div class="line">MS: 7 Custom-CustomCrossOver-InsertByte-Custom-ChangeBit-Custom-CustomCrossOver-; base unit: 90863b4d83c3f994bba0a417d0c2ee3b68f9e795</div>
<div class="line">0x6f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x20,0x7b,0xa,0x20,0x20,0x6b,0x65,0x79,0x3a,0x20,0x22,0x21,0x22,0xa,0x20,0x20,0x76,0x61,0x6c,0x75,0x65,0x3a,0x20,0x22,0x21,0x22,0xa,0x20,0x20,0x74,0x79,0x70,0x65,0x3a,0x20,0x50,0x55,0x54,0xa,0x7d,0xa,0x6f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x20,0x7b,0xa,0x20,0x20,0x6b,0x65,0x79,0x3a,0x20,0x22,0x2b,0x22,0xa,0x20,0x20,0x74,0x79,0x70,0x65,0x3a,0x20,0x50,0x55,0x54,0xa,0x7d,0xa,0x6f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x20,0x7b,0xa,0x20,0x20,0x6b,0x65,0x79,0x3a,0x20,0x22,0x2e,0x22,0xa,0x20,0x20,0x74,0x79,0x70,0x65,0x3a,0x20,0x50,0x55,0x54,0xa,0x7d,0xa,0x6f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x20,0x7b,0xa,0x20,0x20,0x6b,0x65,0x79,0x3a,0x20,0x22,0x5c,0x32,0x35,0x33,0x22,0xa,0x20,0x20,0x74,0x79,0x70,0x65,0x3a,0x20,0x50,0x55,0x54,0xa,0x7d,0xa,</div>
<div class="line">operations {\x0a  key: \&quot;!\&quot;\x0a  value: \&quot;!\&quot;\x0a  type: PUT\x0a}\x0aoperations {\x0a  key: \&quot;+\&quot;\x0a  type: PUT\x0a}\x0aoperations {\x0a  key: \&quot;.\&quot;\x0a  type: PUT\x0a}\x0aoperations {\x0a  key: \&quot;\\253\&quot;\x0a  type: PUT\x0a}\x0a</div>
<div class="line">artifact_prefix=&#39;./&#39;; Test unit written to ./crash-a1460be302d09b548e61787178d9edaa40aea467</div>
<div class="line">Base64: b3BlcmF0aW9ucyB7CiAga2V5OiAiISIKICB2YWx1ZTogIiEiCiAgdHlwZTogUFVUCn0Kb3BlcmF0aW9ucyB7CiAga2V5OiAiKyIKICB0eXBlOiBQVVQKfQpvcGVyYXRpb25zIHsKICBrZXk6ICIuIgogIHR5cGU6IFBVVAp9Cm9wZXJhdGlvbnMgewogIGtleTogIlwyNTMiCiAgdHlwZTogUFVUCn0K</div>
<div class="line">./sst_file_writer_fuzzer  5.97s user 4.40s system 64% cpu 16.195 total</div>
</div><!-- fragment --><p>Within 6 seconds, it catches the bug.</p>
<p>The input that triggers the bug is persisted in <code>./crash-a1460be302d09b548e61787178d9edaa40aea467</code>:</p>
<div class="fragment"><div class="line">$ cat ./crash-a1460be302d09b548e61787178d9edaa40aea467</div>
<div class="line">operations {</div>
<div class="line">  key: &quot;!&quot;</div>
<div class="line">  value: &quot;!&quot;</div>
<div class="line">  type: PUT</div>
<div class="line">}</div>
<div class="line">operations {</div>
<div class="line">  key: &quot;+&quot;</div>
<div class="line">  type: PUT</div>
<div class="line">}</div>
<div class="line">operations {</div>
<div class="line">  key: &quot;.&quot;</div>
<div class="line">  type: PUT</div>
<div class="line">}</div>
<div class="line">operations {</div>
<div class="line">  key: &quot;\253&quot;</div>
<div class="line">  type: PUT</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md51"></a>
Reproduce the crash to debug</h2>
<p>The above crash can be reproduced by <code>./sst_file_writer_fuzzer ./crash-a1460be302d09b548e61787178d9edaa40aea467</code>, so you can debug the crash.</p>
<h1><a class="anchor" id="autotoc_md52"></a>
Future Work</h1>
<p>According to <a href="https://github.com/google/oss-fuzz">OSS-Fuzz</a>, <code>as of June 2020, OSS-Fuzz has found over 20,000 bugs in 300 open source projects.</code></p>
<p>RocksDB can join OSS-Fuzz together with other open source projects such as sqlite. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b05962af846a36bbc52d05dfc046b2b4.html">fuzz</a></li>
    <li class="footer">다음에 의해 생성됨 :  <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
